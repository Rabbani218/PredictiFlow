name: Docker smoke test (manual)

on:
  workflow_dispatch:

jobs:
  smoke:
    name: Build and smoke-test (manual)
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and start services
        run: |
          docker compose up --build -d

      - name: Wait for backend health
        run: |
          set -e
          max_retries=30
          delay=5
          n=0
          until [ $n -ge $max_retries ]; do
            if curl -sSf http://localhost:8000/health -m 5 >/dev/null 2>&1; then
              echo "Backend healthy"
              exit 0
            fi
            echo "Waiting for backend... ($((n+1)))"
            n=$((n+1))
            sleep $delay
          done
          echo "Backend did not become healthy within timeout"
          docker compose logs --tail=200 || true
          exit 1

      - name: Tear down
        if: always()
        run: |
          docker compose down --volumes
